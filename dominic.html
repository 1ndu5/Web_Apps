<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dominic System">
    <meta name="theme-color" content="#3498db">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkRvbWluaWMgU3lzdGVtIFRyYWluaW5nIiwKICAic2hvcnRfbmFtZSI6ICJEb21pbmljIFN5c3RlbSIsCiAgImRlc2NyaXB0aW9uIjogIlRyYWluIHlvdXIgbWVtb3J5IHVzaW5nIHRoZSBEb21pbmljIFN5c3RlbSBtZXRob2QiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y1ZjVmNSIsCiAgInRoZW1lX2NvbG9yIjogIiMzNDk4ZGIiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhNREFpSUdobGFXZG9kRDBpTVRBd0lpQjJhV1YzUW05NFBTSXdJREFnTVRBd0lERXdNQ0krUEcxbGRHRWdabWxzYkQwaUl6TTBPVGhrWWlJK1BISmxZM1FnZDJsa2RHZzlJakV3TUNJZ2FHVnBaMmgwUFNJeE1EQWlJR1pwYkd3OUluVnliQ2dnSXpNME9UaGtZaUlnTHo0OGNHRjBhQ0JrUFNKTk5UQXVOekl3SUVNeE1DNDVNRFU1T1RNeU9DQXhNQzQ1TURVNU9UTXlPQ0JETTE0Z01UQXVPVEExT1RneE9Ua2dNVEF1T1RBMU9UZ3hPVGtnTFRRNU9DNHhNVGc1T1RZMU55QXlOQ0F5TkNBeU5DQXlOQ0F0TVRBeUxqazRNalE1TXpJeElERTJNQzQwTnpVeUlERTJNQzQwTnpVeUlERTFMalF4T1RnNU1URXlJRGcwTGprME56QTVNVEk0SUVNeE5pNDBOek16TkRnNUlEZ3pMakk1TURNME5qSTNJREUzTGpZek5qYzNNVEk0SUc0ekxqWTJOelV5TURJNSBNSUF6TWk0NE9ETTRPVEkwSWlCbWFXeHNQU0lqTXpRNU9HUmlJaUJ6ZEhKdmEyVTlJaU16TkRrNFpHSWlJSE4wY205clpTMTNhV1IwYUQwaU1pSWdjM1J5YjJ0bExXeHBibVZqWVhBOUluSnZkVzVrSWlCemRISnZhMlV0YkdsdVpXcHZhVzQ5SW05MWRHVnlJaUF2UGp3dmJXVjBZVDQ4Wm05dWRDQm1ZVzFwYkhrOUluTmhiaXMxWnk1aWJHRmpheUlnYzJsNlpUMGlOVEJsYlNJZ2MyTnNaV0ZuWlQwaVkyOXZjaUkvUGp4emRtZGZkbWxsZHlCNFBTSXpPQ0lnZVQwaU16Z2lJSFpwWlhjdFlteEVZVG9pTVNBd0lERWdNQ0F4SURBaVBnbzhZeUJrUFNKdGN5NHdJRFF3SUdVdU5DMDFNaUJoTFNBM0lpQjRNVDBpTXlJZ2VERTlJamd6SWlCNE1UMGlNeklpSUhneVBTSXhNRGNpSUhnelBTSXhNaklpSUhnMFBTSXhNVGNpSUhobFBTSXhNRFVpSUhsa1BTSXhNek1pSUhseVBTSTBNaUlnWm1sc2JEMGlJek0wT1Roa1lpSWdZM1J5YkQwaVkzVnliR2x2ZW5vaVBrMEhCeDVEUGp4MEtFRTVQU0l4TWpKZklnMEtSRHhmREJjck5nMEtQaUJ3TmpEeCsrTk9SVUFoWHlJOEwzUStQR01nWkQwaWJYTXVOalE0SUVRdU9ESTZLRFF3T2tJNklHVXVORFluSUM4K0pHZGZkOWs4TDJNKzdCeDBQaVJCZURKVndkOWVKRnBjUVVGQlFVRkJRU0kwTVFCTlJ5SUQvVVAzNk9IUHlEeHpkbWRmZG1sbGR6NDhkR1Y0ZENCNFBTSXhOakFpSUhrOUlqazFJaTgrUEhSbGVIUWdlRDBpTWpVaUlIazlJalkyTmlJdlBqeDBlSFJnZUQwaU1UYzFJaUI1UFNJMk5pSXZQanh6ZEhKdmEyVWdkMmxrZEdnOUlqSWlJSE4wY205clpTMXNhVzVsWTJGd1BTSnliM1Z1WkNJZ2MzUnliMnRsTFd4cGJtVnFiMmx1UFNKdmRYUmxjaUlnYzNSeWIydGxQU0lqTXpRNU9HUmlJaTgrUEhSeVlXNXpabTl5YlNCMGNtRnVjMnhoZEdVOUlqRXdNUzQxSURZNUxqVWlJQzgrUEM5emRtYytQRzVoZENCNE1UMGlNVEFpSUhneVBTSXlPU0lnZVRFOUlqZ3pJaUI1TWowaU9USWlQZz09IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSTJOQ0lnYUdWcFoyaDBQU0kyTkNJZ2RtbGxkMEp2ZUQwaU1DQXdJRFkwSURZMElqNDhiV1YwWVNCbWFXeHNQU0lqTXpRNU9HUmlJajQ4Y21WamRDQjNhV1IwYUQwaU5qUWlJR2hsYVdkb2REMGlOalFpSUdacGJHdzlJblZ5YkNJZ0l6TTBPVGhrWWlJZ0x6NDhjR0YwYUNCa1BTSk5NVFV1TlRVMklFMHhNeTQ0TnpRMUlqVk1SQzR5TnpjMklGQjNZeUEwTGpjMk9EY2dOQzQzTmpnM0lEUXVOelk0TnlBeEF5QTFMamM0TURRZ05TNDNPREEwSURVdU56Z3dOQU1nTmk0ME56RTBJRFl1TkRjeE5DQTNMakU0TVRBZ05pNHhOakVuSWlCbWFXeHNQU0lqTXpRNU9HUmlJaUJ6ZEhKdmEyVTlJaU16TkRrNFpHSWlJSE4wY205clpTMTNhV1IwYUQwaU1pSWdjM1J5YjJ0bExXeHBibVZqWVhBOUluSnZkVzVrSWlCemRISnZhMlV0YkdsdVpXcHZhVzQ5SW05MWRHVnlJaUF2UGp3dmJXVjBZVDQ4Wm05dWRDQm1ZVzFwYkhrOUluTmhiaXMxWnk1aWJHRmpheUlnYzJsNlpUMGlOVEJsYlNJZ2MyTnNaV0ZuWlQwaVkyOXZjaUkvUGp4emRtZGZkbWxsZHlCNFBTSXpPQ0lnZVQwaU16Z2lJSFpwWlhjdFlteEVZVG9pTVNBd0lERWdNQ0F4SURBaVBnbzhjaUJrUFNKdE5qQXlJSEJoTVRBeklDSWdlamMySURNaUxqQTNOamt3SURBNk1qbzRQMEZ6TURKQlZGUWdRM281T1RrMGdTSWdabWxzYkQwaUl6TTBPVD1vbjhpSWlCemRISnZhMlU5SWlBak16UTVPREJlbVpwYkd3OUlsZGhjMlVpUFRnNk5qQT0rUGp4MGVIUWdYbnQ4ZlQ5ZGVIUWdlRDBpTXlJZ2VUMGlPREFpSUhOM1lYQWdhRGRmaGNpd2dkekFhblZrYmtkZVVrPWdVVlE2YTBnZ2Irb2xJajQrUEM5MApQaVJYMmZrL1BTOW1iMjUwUGlKd1pqc3hOek55ZFNJdlBqeHpkbWMrTzFBzaW5mPSI9PQoJICAgIH0KICBdCn0=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PG1ldGEgZmlsbD0iIzM0OThkYiIvPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSJ1cmwiICIjMzQ5OGRiIiAvPjxwYXRoIGQ9Ik01MC43MjAgQzEwLjkwNTk5MzI4IDEwLjkwNTk5MzI4IC00OTguMTE4OTk3NjU3IDI0IDI0IDI0IC0xMDIuOTgyNDkzMjEgMTYwLjQ3NTIgMTYwLjQ3NTIgMTUuNDE5ODkxMTIgODQuOTQ3MDkxMjggQzE2LjQ3MzM0ODkgODMuMjkwMzQ2MjcgMTcuNjM2NzcxMjggbzMuNjY3NTIwMjkgMzIuODgzODkyNCAwLjIiIGZpbGw9IiMzNDk4ZGIiIHN0cm9rZT0iIzM0OThkYiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0ib3V0ZXIiIC8+PGZvbnQgZmFtaWx5PSJzYW5zLTVnLmJsYWNrIiBzaXplPSI1MGVtIiBzY2xlYWc9ImNvb3IiPjxzdmdfaWV3IHg9IjM4IiB5PSIzOCIgdmlld0JveDE9IjEgMCAxIDAiPgo8YyBkPSJtcy4wIDQwIGUuNC01MiBhLSA3IiB4MT0iMyIgeDE9IjgzIiB4MT0iMzIiIHgyPSIxMDciIHgzPSIxMjIiIHg0PSIxMTciIHhlPSIxMDUiIHlkPSIxMzMiIHlyPSI0MiIgZmlsbD0iIzM0OThkYiIgY3RybD0iY3VybGlvelAiPkQbhx5DPHQoQTk9IjEyMnciFw0KRD0YLA4rNg0KPiBwNjDx++1PUkVBIVwiPH90PjxjIGQ9Im1zLjY0OCBSLjgzOig0MDpCOiBlLjRhIiAvPiRnX3c9PC9jPuw8dD4kQXgyVcHfXiRaXEFBQUFBQUFCIjQxQE5HIkP/UP3o4c/IPHNlZl92aWV3Pjx0ZXh0IHg9IjE2MCIgeT0iOTUiPjx0ZXh0IHg9IjI1IiB5PSI2NjYiLz48dGV4dCB4PSIxNzUiIHk9IjY2Ij48c3Ryb2tlIHdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0ib3V0ZXIiIHN0cm9rZT0iIzM0OThkYiIvPjx0cmFuc2Zvcm0gdHJhbnNsYXRlPSIxMDEuNSA2OS41IiAvPjwvc3ZnPjxuYXQgeDE9IjEwIiB4Mj0iMjkiIHkxPSI4MyIgeTI9IjkyIj4=">
    <link rel="apple-touch-startup-image" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzOTAiIGhlaWdodD0iODQ0IiB2aWV3Qm94PSIwIDAgMzkwIDg0NCI+PHJlY3Qgd2lkdGg9IjM5MCIgaGVpZ2h0PSI4NDQiIGZpbGw9IiMzNDk4ZGIiLz48dGV4dCB4PSIxNjAiIHk9IjQyMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNTAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+RDwvdGV4dD48L3N2Zz4=">
    <title>Dominic System Training</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html {
            overscroll-behavior: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0 auto;
            padding: 10px;
            max-width: 800px;
            background-color: #f5f5f5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .standalone body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 24px;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s;
            font-weight: 500;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        button:hover, button:active {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            width: 100%;
            margin: 5px 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1em;
            padding-right: 30px;
        }
        
        .number-display {
            font-size: 24px;
            text-align: center;
            margin: 25px 0;
            min-height: 48px;
            font-family: -apple-system, monospace;
            letter-spacing: 3px;
            word-break: break-all;
            line-height: 1.4;
        }
        
        .input-area {
            text-align: center;
            margin-top: 20px;
            width: 100%;
        }
        
        #userInput {
            width: 100%;
            padding: 8px;
            font-size: 24px;
            font-family: -apple-system, monospace;
            letter-spacing: 2px;
            border: 2px solid #ddd;
            text-align: center;
            border-radius: 4px;
            user-select: text;
            -webkit-user-select: text;
        }
        
        .result {
            text-align: center;
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 15px;
            color: #2c3e50;
            min-height: 24px;
            font-weight: 500;
        }
        
        .correct {
            color: #27ae60;
            font-weight: bold;
            font-size: 22px;
        }
        
        .incorrect {
            color: #e74c3c;
            font-weight: bold;
            font-size: 22px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
        }
        
        .stat-item {
            text-align: center;
            padding: 5px 2px;
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 3px;
        }
        
        .settings-panel {
            margin-top: 15px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .settings-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }
        
        .settings-label {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .settings-control {
            width: 100%;
        }
        
        .help-text {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }
        
        .hidden {
            display: none;
        }
        
        /* iPhone orientation specific styles */
        .custom-keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 300px;
            margin: 70px auto 0;
        }
        
        .key {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px 0;
            font-size: 18px;
            text-align: center;
            touch-action: manipulation;
        }
        
        .key:active {
            background-color: #e2e6ea;
        }
        
        .key-enter {
            background-color: #3498db;
            color: white;
        }
        
        .key-enter:active {
            background-color: #2980b9;
        }
        
        .key-backspace {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* More compact layout for iPhone */
        body {
            padding: 5px;
        }
        
        .container {
            padding: 12px 16px;
        }
        
        .number-display {
            margin: 20px 0;
        }
        
        .input-area {
            margin-top: 15px;
        }
        
        .result {
            margin-top: 12px;
            margin-bottom: 12px;
        }
        
        .stats {
            margin-top: 12px;
            padding: 10px;
        }
        
        .stat-value {
            font-size: 20px;
        }
        
        @media screen and (max-width: 390px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Fix for iOS inputs zoom */
        @media screen and (max-width: 768px) {
            input[type="text"], input[type="number"], select {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dominic System Training</h1>
        
        <div class="controls">
            <button id="startBtn">Start New Sequence</button>
            <button id="settingsBtn">Settings</button>
        </div>
        
        <div class="settings-panel hidden" id="settingsPanel">
            <h3>Settings</h3>
            <div class="settings-row">
                <div class="settings-label">Difficulty Level:</div>
                <div class="settings-control">
                    <select id="difficultyLevel">
                        <option value="easy">Easy (4 digits)</option>
                        <option value="medium" selected>Medium (6 digits)</option>
                        <option value="hard">Hard (8 digits)</option>
                        <option value="expert">Expert (16 digits)</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-row hidden" id="customSettings">
                <div class="settings-label">Custom Length:</div>
                <div class="settings-control">
                    <input type="number" id="customLength" min="2" max="100" value="10" pattern="[0-9]*" inputmode="numeric">
                </div>
            </div>
            
            <div class="settings-row">
                <div class="settings-label">Display Time (seconds):</div>
                <div class="settings-control">
                    <input type="number" id="displayTime" min="1" max="60" value="5" pattern="[0-9]*" inputmode="numeric">
                </div>
            </div>
            
            <div class="settings-row">
                <div class="settings-label">Group Digits:</div>
                <div class="settings-control">
                    <select id="groupDigits">
                        <option value="none">None</option>
                        <option value="pairs" selected>Pairs (12 34 56)</option>
                        <option value="triplets">Triplets (123 456)</option>
                        <option value="quads">Quads (1234 5678)</option>
                    </select>
                </div>
            </div>
            

            
            <button id="saveSettingsBtn">Save Settings</button>
        </div>
        
        <div class="number-display" id="numberDisplay">Press "Start" to begin</div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Type the numbers here..." disabled pattern="[0-9 ]*" inputmode="numeric">
            
            <div class="custom-keyboard" id="customKeyboard">
                <div class="key" data-key="1">1</div>
                <div class="key" data-key="2">2</div>
                <div class="key" data-key="3">3</div>
                <div class="key" data-key="4">4</div>
                <div class="key" data-key="5">5</div>
                <div class="key" data-key="6">6</div>
                <div class="key" data-key="7">7</div>
                <div class="key" data-key="8">8</div>
                <div class="key" data-key="9">9</div>
                <div class="key key-backspace" data-key="backspace">⌫</div>
                <div class="key" data-key="0">0</div>
                <div class="key key-enter" data-key="enter">↵</div>
            </div>
        </div>
        
        <div class="result" id="result"></div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="currentStreak">0</div>
                <div class="stat-label">Current Streak</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="longestStreak">0</div>
                <div class="stat-label">Longest Streak</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="accuracy">0%</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalTrials">0</div>
                <div class="stat-label">Total Trials</div>
            </div>
        </div>
    </div>

    <script>

        
        // DOM Elements
        const numberDisplay = document.getElementById('numberDisplay');
        const userInput = document.getElementById('userInput');
        const startBtn = document.getElementById('startBtn');
        const checkBtn = document.getElementById('checkBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const difficultyLevel = document.getElementById('difficultyLevel');
        const customSettings = document.getElementById('customSettings');
        const customLength = document.getElementById('customLength');
        const displayTime = document.getElementById('displayTime');
        const groupDigits = document.getElementById('groupDigits');

        const result = document.getElementById('result');
        const totalTrials = document.getElementById('totalTrials');
        const accuracy = document.getElementById('accuracy');
        const currentStreak = document.getElementById('currentStreak');
        const longestStreak = document.getElementById('longestStreak');
        
        // Game state
        let currentNumber = '';
        let gameActive = false;
        let stats = {
            trials: 0,
            correct: 0,
            currentStreak: 0,
            longestStreak: 0
        };
        
        // Load saved stats from localStorage if available
        function loadSavedStats() {
            try {
                const savedStats = localStorage.getItem('numberMemoryStats');
                if (savedStats) {
                    stats = JSON.parse(savedStats);
                    updateStats();
                }
            } catch (error) {
                console.log('Unable to load saved stats: localStorage may not be available');
                // Continue without saved stats
            }
        }
        
        // Save stats to localStorage
        function saveStats() {
            try {
                localStorage.setItem('numberMemoryStats', JSON.stringify(stats));
            } catch (error) {
                console.log('Unable to save stats: localStorage may not be available');
                // Continue without saving stats
            }
        }
        
        // Event Listeners
        startBtn.addEventListener('click', startNewGame);
        settingsBtn.addEventListener('click', toggleSettings);
        saveSettingsBtn.addEventListener('click', saveSettings);
        difficultyLevel.addEventListener('change', toggleCustomDifficulty);

        // Add listeners for custom keyboard
        document.querySelectorAll('.key').forEach(key => {
            key.addEventListener('click', function() {
                const keyValue = this.getAttribute('data-key');
                handleKeyPress(keyValue);
            });
        });
        
        // Handle key presses
        function handleKeyPress(key) {
            if (key === 'enter') {
                if (gameActive) {
                    // If game is active, check answer
                    checkAnswer();
                } else if (!startBtn.disabled) {
                    // If game is over but start button is enabled, start new game
                    startNewGame();
                }
            } else if (key === 'backspace') {
                // Only process if input is enabled
                if (!userInput.disabled) {
                    userInput.value = userInput.value.slice(0, -1);
                }
            } else {
                // Add digit to input only if input is enabled
                if (!userInput.disabled) {
                    userInput.value += key;
                }
            }
        }
        
        // Disable default keyboard on input focus
        userInput.addEventListener('focus', function(e) {
            // Prevent the mobile keyboard from showing up
            if (isIOS()) {
                this.blur();
            }
        });
        
        // Handle keypress events for better workflow
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default to avoid keyboard issues
                
                if (gameActive) {
                    // If the game is active, check the answer
                    checkAnswer();
                } else if (!startBtn.disabled) {
                    // If the game is not active and the start button is enabled (after checking an answer)
                    // Start a new game
                    startNewGame();
                }
            }
        });
        
        // Ensure numeric keyboard on iOS
        userInput.addEventListener('focus', function() {
            userInput.setAttribute('inputmode', 'numeric');
        });
        
        // Handle orientation changes
        window.addEventListener('resize', function() {
            adjustForOrientation();
        });
        
        // Functions
        function startNewGame() {
            gameActive = true;
            userInput.value = '';
            result.textContent = '';
            result.className = 'result';
            
            // Generate number based on settings
            currentNumber = generateNumber();
            const formattedNumber = formatNumberWithGrouping(currentNumber);
            
            // Display the number
            numberDisplay.textContent = formattedNumber;
            startBtn.disabled = true;
            
            // Set timer to hide the number
            const seconds = parseInt(displayTime.value) || 5;
            setTimeout(() => {
                numberDisplay.textContent = '•'.repeat(formattedNumber.length);
                userInput.disabled = false;
                userInput.focus();

                
                // Ensure the keyboard is shown on iOS
                if (isIOS()) {
                    userInput.blur();
                    setTimeout(() => userInput.focus(), 100);
                }
            }, seconds * 1000);
        }
        
        function generateNumber() {
            const difficulty = difficultyLevel.value;
            let length;
            
            switch(difficulty) {
                case 'easy':
                    length = 4; // Exactly 4 digits
                    break;
                case 'medium':
                    length = 6; // Exactly 6 digits
                    break;
                case 'hard':
                    length = 8; // Exactly 8 digits
                    break;
                case 'expert':
                    length = 16; // Exactly 16 digits
                    break;
                case 'custom':
                    length = parseInt(customLength.value) || 10;
                    break;
                default:
                    length = 6;
            }
            
            // Always use random digits
            let number = '';
            for(let i = 0; i < length; i++) {
                number += Math.floor(Math.random() * 10).toString();
            }
            
            return number;
        }
        
        function formatNumberWithGrouping(number) {
            const groupingType = groupDigits.value;
            let formattedNumber = '';
            
            switch(groupingType) {
                case 'pairs':
                    for(let i = 0; i < number.length; i += 2) {
                        formattedNumber += number.substring(i, i + 2) + ' ';
                    }
                    break;
                case 'triplets':
                    for(let i = 0; i < number.length; i += 3) {
                        formattedNumber += number.substring(i, i + 3) + ' ';
                    }
                    break;
                case 'quads':
                    for(let i = 0; i < number.length; i += 4) {
                        formattedNumber += number.substring(i, i + 4) + ' ';
                    }
                    break;
                default:
                    formattedNumber = number;
            }
            
            return formattedNumber.trim();
        }
        
        function checkAnswer() {
            if (!gameActive) return;
            
            gameActive = false;

            userInput.disabled = true;
            
            // Set focus to the document body to ensure Enter key event is captured
            document.body.focus();
            
            // Remove spaces from user input for comparison
            const cleanInput = userInput.value.replace(/\s+/g, '');
            const isCorrect = cleanInput === currentNumber;
            
            // Update stats
            stats.trials++;
            if (isCorrect) {
                stats.correct++;
                stats.currentStreak++;
                if (stats.currentStreak > stats.longestStreak) {
                    stats.longestStreak = stats.currentStreak;
                }
            } else {
                // Reset streak on incorrect answer
                stats.currentStreak = 0;
            }
            
            // Try to save stats
            saveStats();
            
            // Update UI
            numberDisplay.textContent = formatNumberWithGrouping(currentNumber);
            
            if (isCorrect) {
                result.textContent = '✓ Correct!';
                result.className = 'result correct';
                // Optional: Add haptic feedback for success
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            } else {
                result.textContent = '✗ Incorrect. Try again!';
                result.className = 'result incorrect';
                // Optional: Add haptic feedback for failure
                if (navigator.vibrate) {
                    navigator.vibrate([50, 100, 50]);
                }
            }
            
            updateStats();
            startBtn.disabled = false;
            
            // Hide keyboard on iOS
            if (isIOS()) {
                userInput.blur();
            }
        }
        
        function toggleSettings() {
            settingsPanel.classList.toggle('hidden');
            
            // If opening settings panel, focus on first input
            if (!settingsPanel.classList.contains('hidden')) {
                difficultyLevel.focus();
            }
        }
        
        function toggleCustomDifficulty() {
            if (difficultyLevel.value === 'custom') {
                customSettings.classList.remove('hidden');
            } else {
                customSettings.classList.add('hidden');
            }
        }
        
        function saveSettings() {
            settingsPanel.classList.add('hidden');
             // Save the settings to localStorage
            saveUserSettings();
            // Focus back on the start button
            startBtn.focus();
        }
        
        function updateStats() {
            currentStreak.textContent = stats.currentStreak;
            longestStreak.textContent = stats.longestStreak;
            accuracy.textContent = stats.trials > 0 ? 
                Math.round((stats.correct / stats.trials) * 100) + '%' : '0%';
            totalTrials.textContent = stats.trials;
        }
        
        function adjustForOrientation() {
            // If in landscape mode on iPhone, adjust layout
            if (window.innerWidth > window.innerHeight && isIOS()) {
                document.body.classList.add('landscape');
            } else {
                document.body.classList.remove('landscape');
            }
        }
        
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // Save settings to localStorage
        function saveUserSettings() {
            try {
                const settings = {
                    difficulty: difficultyLevel.value,
                    customLength: customLength.value,
                    displayTime: displayTime.value,
                    groupingMethod: groupDigits.value
                };
                localStorage.setItem('numberMemorySettings', JSON.stringify(settings));
                console.log('Settings saved successfully');
            } catch (error) {
                console.log('Unable to save settings: localStorage may not be available');
            }
        }
        
        // Load settings from localStorage
        function loadSavedSettings() {
            try {
                const savedSettings = localStorage.getItem('numberMemorySettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    
                    // Apply saved settings to UI
                    difficultyLevel.value = settings.difficulty || 'medium';
                    customLength.value = settings.customLength || 10;
                    displayTime.value = settings.displayTime || 5;
                    groupDigits.value = settings.groupingMethod || 'pairs';
                    
                    // Show/hide custom settings based on difficulty
                    toggleCustomDifficulty();
                    
                    console.log('Settings loaded successfully');
                }
            } catch (error) {
                console.log('Unable to load saved settings: localStorage may not be available');
                // Continue with default settings
            }
        }
                
        // Initialize
        toggleCustomDifficulty();
        loadSavedStats();
        loadSavedSettings();
        adjustForOrientation();
        
        // Prevent zoom on double tap for iOS
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Prevent pinch zoom
        document.addEventListener('touchmove', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
